<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Emails - AI Knowledge Base</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%);
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .category-header {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.4) 0%, rgba(168, 85, 247, 0.4) 100%);
        }

        .email-card {
            transition: all 0.2s;
        }

        .email-card:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .search-input {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .search-input:focus {
            border-color: rgba(99, 102, 241, 0.8);
            outline: none;
        }

        html {
            scroll-behavior: smooth;
        }
    </style>
</head>

<body class="gradient-bg min-h-screen text-white">
    <!-- Navigation -->
    <nav class="sticky top-0 z-50 backdrop-blur-lg bg-indigo-950/80 border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üìß</span>
                    <h1
                        class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
                        Browse Emails
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="px-4 py-2 rounded-lg hover:bg-white/10 transition font-medium text-sm">
                        Dashboard
                    </a>
                    <a href="/search" class="px-4 py-2 rounded-lg hover:bg-white/10 transition font-medium text-sm">
                        üîç Search
                    </a>
                    <a href="/learn" class="px-4 py-2 rounded-lg hover:bg-white/10 transition font-medium text-sm">
                        üìö Learn
                    </a>
                    <a href="/browse"
                        class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition font-medium text-sm">
                        Browse Emails
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Stats Overview -->
        <section class="mb-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card rounded-xl p-5">
                    <div class="text-3xl font-bold text-indigo-300">{{ total_emails }}</div>
                    <div class="text-sm text-gray-400 mt-1">Total Emails</div>
                </div>
                <div class="stat-card rounded-xl p-5">
                    <div class="text-3xl font-bold text-purple-300">{{ categories|length }}</div>
                    <div class="text-sm text-gray-400 mt-1">Categories</div>
                </div>
                <div class="stat-card rounded-xl p-5">
                    <div class="text-3xl font-bold text-pink-300">{{ total_links }}</div>
                    <div class="text-sm text-gray-400 mt-1">Resource Links</div>
                </div>
                <div class="stat-card rounded-xl p-5">
                    <div class="text-3xl font-bold text-blue-300">{{ last_updated }}</div>
                    <div class="text-sm text-gray-400 mt-1">Last Updated</div>
                </div>
            </div>
        </section>

        <!-- Search Box -->
        <section class="mb-8">
            <div class="card rounded-2xl p-6">
                <div class="flex flex-col md:flex-row gap-3">
                    <input type="text" id="searchInput"
                        placeholder="Search emails... (e.g., cursor AND agent, openai OR claude, NOT beta)"
                        class="search-input flex-grow px-4 py-3 rounded-lg text-white placeholder-gray-400">
                    <button onclick="performSearch()"
                        class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium transition">
                        Search
                    </button>
                    <button onclick="clearSearch()"
                        class="px-4 py-3 bg-white/10 hover:bg-white/20 rounded-lg font-medium transition">
                        Clear
                    </button>
                </div>
                <p class="text-gray-400 text-sm mt-3">üí° Use AND, OR, NOT for boolean search</p>
            </div>
        </section>

        <!-- Search Results -->
        <div id="searchResults" class="hidden mb-8">
            <div class="card rounded-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Search Results</h2>
                    <span id="resultCount" class="text-gray-400"></span>
                </div>
                <div id="searchResultsList" class="divide-y divide-white/10"></div>
            </div>
        </div>

        <!-- Categories -->
        <section>
            <h2 class="text-2xl font-bold mb-6">üìÅ All Categories</h2>
            <div class="space-y-4">
                {% for cat_name, items in categories.items() %}
                <div class="card rounded-xl overflow-hidden">
                    <div class="category-header px-6 py-4 cursor-pointer flex justify-between items-center"
                        onclick="toggleCategory('cat-{{ loop.index }}', 'icon-{{ loop.index }}')">
                        <div>
                            <h3 class="text-lg font-semibold">{{ cat_name }}</h3>
                            <p class="text-gray-400 text-sm">{{ items|length }} emails</p>
                        </div>
                        <svg id="icon-{{ loop.index }}" class="w-6 h-6 transform transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </div>
                    <div id="cat-{{ loop.index }}" class="hidden divide-y divide-white/5 max-h-96 overflow-y-auto">
                        {% for email in items %}
                        <div class="email-card px-6 py-4">
                            <h4 class="font-medium mb-2">{{ email.subject[:120] }}{% if email.subject|length > 120
                                %}...{% endif %}</h4>
                            {% if email.summary %}
                            <p
                                class="text-gray-300 text-sm mb-3 bg-indigo-900/30 p-3 rounded-lg border-l-4 border-indigo-500">
                                {{ email.summary }}
                            </p>
                            {% else %}
                            <p class="text-gray-400 text-sm mb-2">{{ email.content[:250]|e }}{% if email.content|length
                                > 250 %}...{% endif %}</p>
                            {% endif %}
                            {% if email.enriched_links %}
                            <div class="flex flex-wrap gap-2 mt-2">
                                {% for link in email.enriched_links[:3] %}
                                <a href="{{ link.url }}" target="_blank"
                                    class="inline-flex items-center text-xs px-2 py-1 rounded bg-indigo-900/50 text-indigo-300 hover:bg-indigo-800/50 hover:text-indigo-200 transition"
                                    title="{{ link.description or link.url }}">
                                    üîó {{ link.title or link.domain or link.url[:40] }}{% if not link.title and
                                    link.url|length > 40 %}...{% endif %}
                                </a>
                                {% endfor %}
                                {% if email.enriched_links|length > 3 %}
                                <span class="text-xs text-gray-500">+{{ email.enriched_links|length - 3 }} more</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            <div class="text-xs text-gray-500 mt-2">{{ email.date }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
    </main>

    <footer class="max-w-7xl mx-auto px-4 py-8 mt-8 border-t border-white/10">
        <p class="text-center text-gray-500 text-sm">
            AI Knowledge Base ‚Ä¢ {{ total_emails }} emails from Sept 2024 - Jan 2026
        </p>
    </footer>

    <script>
        const allEmails = {{ emails_json| safe }};

        function toggleCategory(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }

        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') performSearch();
        });

        function parseBoolean(query) {
            query = query.trim();
            if (!query) return () => true;

            const orGroups = query.split(/\s+OR\s+/i);

            return (text) => {
                text = text.toLowerCase();
                return orGroups.some(group => {
                    const andTerms = group.split(/\s+AND\s+/i);
                    return andTerms.every(term => {
                        term = term.trim();
                        if (term.toUpperCase().startsWith('NOT ')) {
                            return !text.includes(term.substring(4).trim().toLowerCase());
                        }
                        return text.includes(term.toLowerCase());
                    });
                });
            };
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value;
            const matcher = parseBoolean(query);

            const results = allEmails.filter(email => {
                const searchText = (email.subject + ' ' + email.content + ' ' + (email.links || []).join(' ')).toLowerCase();
                return matcher(searchText);
            });

            displayResults(results, query);
        }

        function displayResults(results, query) {
            const container = document.getElementById('searchResults');
            const list = document.getElementById('searchResultsList');
            const count = document.getElementById('resultCount');

            container.classList.remove('hidden');
            count.textContent = `${results.length} email${results.length !== 1 ? 's' : ''} found`;

            if (results.length === 0) {
                list.innerHTML = '<p class="text-gray-400 py-4">No emails match your search criteria.</p>';
                return;
            }

            list.innerHTML = results.slice(0, 50).map(email => `
                <div class="email-card py-4">
                    <span class="inline-block px-2 py-1 text-xs font-medium bg-indigo-600/50 rounded mb-2">${escapeHtml(email.category)}</span>
                    <h4 class="font-medium mb-2">${escapeHtml(email.subject.substring(0, 120))}${email.subject.length > 120 ? '...' : ''}</h4>
                    ${email.summary ? `
                        <p class="text-gray-300 text-sm mb-2 bg-indigo-900/30 p-3 rounded-lg border-l-4 border-indigo-500">${escapeHtml(email.summary)}</p>
                    ` : `
                        <p class="text-gray-400 text-sm mb-2">${escapeHtml(email.content.substring(0, 300))}${email.content.length > 300 ? '...' : ''}</p>
                    `}
                    <div class="text-xs text-gray-500 mt-2">${escapeHtml(email.date || '')}</div>
                </div>
            `).join('');

            if (results.length > 50) {
                list.innerHTML += `<p class="text-gray-400 text-sm py-4">Showing first 50 of ${results.length} results</p>`;
            }

            container.scrollIntoView({ behavior: 'smooth' });
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').classList.add('hidden');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>